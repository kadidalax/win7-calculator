name: Build C++ Win32 Calculator

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
      
    - name: Build with MSVC
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        rc.exe /nologo resource.rc
        cl.exe /O2 /MT /DUNICODE /D_UNICODE /Fe:Calculator_Win7.exe calc_win7.cpp resource.res user32.lib gdi32.lib comctl32.lib dwmapi.lib shell32.lib comdlg32.lib Msimg32.lib /link /SUBSYSTEM:WINDOWS /ENTRY:wWinMainCRTStartup
        
    - name: Check file size
      shell: pwsh
      run: |
        $size = (Get-Item "Calculator_Win7.exe").Length
        Write-Host "EXE Size: $([math]::Round($size/1KB, 2)) KB"
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: Calculator_Win7_CPP
        path: Calculator_Win7.exe
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: Calculator_Win7.exe
        name: Release ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
